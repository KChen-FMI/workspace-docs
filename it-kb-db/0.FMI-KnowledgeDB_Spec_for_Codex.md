# FMI KnowledgeDB（AI分解→構造化DB→RAG類似探索→人間確定→Export）仕様（Codex投入用）

> 目的：このドキュメントは、FMIの既存資料（Excel/Word/PDF/OneNote等）をAIで分解し、Operation/Issue/Step/Problem/RuleとしてDB化し、RAGで類似探索しつつ人間が確定・運用し、最後に作業単位で手順書をExportできる状態までを「コード前提」で実装するための仕様まとめ。

---

## 0. 非採用・前提

- **Azure前提**で構築する（Copilot Studioは採用しない）
- 既存の Excel / Word / PDF / OneNote はすべて **一時資料（作業中・履歴・断片）** として扱う  
  - 用途はドキュメントタイプで一定しない（Excel=一覧/判断表/設計メモ、Word=詳細手順/文章メモ、PDF=配布物/旧版/外部資料、OneNote=作業ログ/思考メモ等）
- **正（Single Source of Truth）は構造化DB** とする
- RAGは **「似ている情報の探索」** に限定し、最終判断は人間が行う
- AI出力は **自由作文ではなくJSON固定**（構造抽出・正規化に限定）

---

## 1. 目的（Why）

既存資料をAIで理解・分解し、以下の構造に再構成して一元管理する：

- **Operation**（業務シナリオ：入社/退社/PC交換…）
- **Issue**（作業単位：アカウント作成/端末設定…）
- **Step**（操作手順：クリック/入力/確認…）
- **Problem**（詰まり・障害・例外：症状/原因/回避策…）
- **Rule**（判断条件・制約：対象/前提/条件分岐…）

これにより：
- 体系化（カタログ）と検索性の両立
- 不足/重複/例外の可視化
- チケット（Issue Tracking）との関連付け
- 作業に必要な手順書の **Export（再構成出力）**
を実現する。

---

## 2. 設計原則（Design Principles）

### 2.1 分業
- 一時資料：混沌でOK（思考・作業を止めない）
- AI：分解・正規化・関連付け（**断定しない**）
- DB：正（最新版・統制・集計の対象）
- 人間：確定（採用/統合/却下）と理由ログ

### 2.2 禁止事項
- AIの自動確定（自動公開/自動採用）
- Word/PDF/OneNoteを正として運用
- RAGを意思決定主体にする
- confidenceをKPI化する

---

## 3. 全体アーキテクチャ（Azure）

概念図：

```
[ SharePoint / OneNote / Files ]
        ↓（取込）
[ Azure Functions / Durable Functions ]
        ↓（抽出・正規化）
[ Azure OpenAI ]
   └ JSON（Operation/Issue/Step/Problem/Rule）
        ↓（保存）
[ Knowledge DB ]
        ↓（索引）
[ Azure AI Search ]
        ↓（比較カード生成）
[ Review UI (React) ]
        ↓（人が確定）
[ Confirmed DB ]
        ↓（派生生成）
[ Export（MD/PDF/Word/HTML） ]
```

補足：
- 原本は参照用にBlobへスナップショット保管してもよい（SourceRef用）
- 認証はEntra ID、秘密情報はKey Vault、監視はApp Insights/Log Analytics想定

---

## 4. データモデル（正の構造）

### 4.1 Operation
- id
- name
- description
- required_issue_ids[]（順序/必須フラグ含む）
- frequency（高/中/低 など）
- owner

### 4.2 Issue
- id
- name
- type（account/device/permission/app など）
- related_operation_ids[]
- step_ids[]
- problem_ids[]
- rule_ids[]
- status（Draft/Confirmed/Deprecated）
- source_refs[]

### 4.3 Step
- id
- issue_id
- action
- target
- order
- risk_level（低/中/高）
- source_refs[]

### 4.4 Problem
- id
- symptom
- cause
- workaround
- related_issue_ids[]
- source_refs[]

### 4.5 Rule
- id
- scope（Operation/Issue/Step）
- condition（if/when）
- constraint（must/should）
- source_refs[]

### 4.6 SourceRef（参照資料）
- id
- type（Excel/Word/PDF/OneNote）
- url（SharePoint/OneNote/Blob等）
- location（page/sheet/section/heading など）
- captured_at（スナップショット日時）
- frozen（true/false）

---

## 5. AI分解（JSON固定）と confidence ルール

### 5.1 AIの役割（固定）
AIは以下のみを行う：
- 分解（Operation/Issue/Step/Problem/Rule）
- タグ付け（対象/カテゴリ/デバイス等）
- 既存DB候補への関連付け（**confidence付き**）
- 出力はJSONのみ（文章自由生成禁止）

### 5.2 confidence の位置づけ
- confidenceは **正しさの保証ではない**
- 人間の判断を助ける **注意喚起の強さ**
- 閾値は頻繁に変えない（運用が壊れる）

### 5.3 confidence帯と運用

#### 🟢 0.80–1.00（高）
- 既存エントリへの **統合候補** として優先表示
- 新規登録はデフォルトOFF
- 人間が「統合」or「別物」判定

#### 🟡 0.50–0.79（中）
- Draftとして新規候補登録
- 既存候補との比較カードを必ず提示
- 人間が「採用/統合」判定

#### 🔴 0.00–0.49（低）
- 孤立候補としてDraft登録（Operation未紐付け許容）
- 後で見直す前提で保持（捨てない）

### 5.4 比較カード（RAG出力の固定フォーマット）
- 候補タイトル（ID）
- 一致点（最大3）
- 相違点（最大3）
- 関連Operation/Issue
- 根拠リンク（SourceRef：該当箇所）
- confidence（参考値）

---

## 6. RAG（類似探索）運用

### 6.1 役割
- 「似ている情報があるか」を探す（重複/派生/関連候補）
- 根拠（SourceRef）を集める
- 比較カードを作る（断定しない）

### 6.2 取得方式（推奨）
- ベクトル検索 + キーワード（BM25） + メタデータフィルタのハイブリッド
- 対象/デバイス/カテゴリ/版/更新日などで絞り込み

### 6.3 判断
- 最終判定は人間（同一/重複/近いが別/無関係/保留）
- 判定理由を短文でログ（後の品質向上に効く）

---

## 7. ライフサイクル：「一時資料 → DB化 → 凍結/廃棄」

### 7.1 フェーズ定義
A. **一時資料（Active）**
- 置き場：SharePoint / OneNote / 共有フォルダ等
- 重複・上書き・未整理を許容
- AI取り込み対象

B. **Draft（未確定DB）**
- AI分解結果が入る領域
- confidence付き
- 検索は可能だが「未確定」表示

C. **Confirmed（正）**
- 人間が採用/統合を確定
- Operation/Issue/Step/Problem/Ruleに整合して紐付く
- 確定者・確定日・理由ログを保持

D. **参照資料の整理（凍結/廃棄）**
- 原則：**凍結（Read Only）**
  - SourceRefとして保持
  - DB化後の元資料は更新禁止（新知見は新しい一時資料として投入）
- 例外：廃棄
  - 明確なノイズ/規約上の理由/完全重複など、限定運用

---

## 8. 不足・歪みの可視化（DB集計で出す）

例：
- Operationに required_issue が足りない
- Issueに step/problem/rule が足りない
- 孤立Issue/Problem（Operation未紐付け）
- 似ているが統合されていない候補（高confidenceが複数）

これをダッシュボードや一覧で表示し、改善チケットに繋げる。

---

## 9. チケット連携（将来含む）

- チケット ↔ IssueID（作業単位）
- 障害チケット ↔ ProblemID（症状・回避策）
- 改善チケット ↔ 不足項目（未定義Step/Rule/Issue）

---

## 10. 追加要件：DB化後の Export（作業に基づく手順書出力）

### 10.1 目的
- DBの正（Operation/Issue/Step/Problem/Rule）から、作業目的に合わせた手順書を **再構成して出力**する
- 参照資料はリンクとして付与（証跡）

### 10.2 Export起点（3種類）
1) **Operation起点**（例：入社対応）
2) **Issue起点**（例：iPhone初期設定）
3) **チケット起点**（例：PC交換チケット#1234）※将来

### 10.3 組み立てルール（固定）
- Operation → required_issue_ids を順序付きで展開
- Issue → step_ids を order昇順で展開
- Problem → 該当Step直下 or 末尾に集約
- フィルタ：対象ロール、デバイス、必須/任意、リスクレベル

### 10.4 出力フォーマット
- Markdown（再編集/Git向き）
- PDF（配布/印刷）
- Word（外注/社外）
- HTML（社内ポータル）

※ 正はDB。形式はすべて派生物。

### 10.5 Draftの扱い
- 原則：Exportは **Confirmedのみ**
- 例外：レビュー用にDraft混在Export（明示ラベル付き）

---

## 11. Codexでの実装開始順（MVP）

1) Repo作成（infra + appsの雛形）
2) 取込パイプライン（Functions/Durable）
   - 資料取得 → テキスト抽出 → LLM(JSON) → Draft保存
3) Knowledge DB（最小：Operation/Issue/SourceRef + status）
4) Azure AI Search（Issue/Problemを先に索引）
5) Review UI（Draft→Confirmed、比較カード表示、理由ログ）
6) 不足可視化（クエリ/集計）
7) Export（まずはMarkdown→PDFは後）

---

## 付録A：最小JSON出力（例）

### Issue候補（AI出力）
```json
{
  "entityType": "Issue",
  "title": "iPhone初期設定（DEP版）",
  "summary": "入社時にiPhoneを初期化し、MDM/Autopilot相当の初期設定を完了する",
  "steps": [
    {"order": 1, "action": "初期化を開始", "target": "設定アプリ"},
    {"order": 2, "action": "Wi‑Fi接続", "target": "ネットワーク選択"}
  ],
  "problems": [
    {"symptom": "MDMプロファイルが適用されない", "workaround": "再起動して再試行"}
  ],
  "mappings": [
    {"targetType": "Operation", "targetName": "入社対応", "confidence": 0.72}
  ],
  "sourceRefs": [
    {"type": "PDF", "url": "<source-url>", "location": "p1-3"}
  ]
}
```

---

（以上）

---

## MVP summary (separate doc)
- See: FMI-KBDB-MVP-spec.md
